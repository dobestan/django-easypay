{% extends "admin/base_site.html" %}
{% load static i18n admin_urls %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block extrahead %}
{{ block.super }}
<link rel="stylesheet" crossorigin
  href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.min.css" />
<link rel="stylesheet" href="{% static 'easypay/dashboard/dashboard.css' %}" />
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
    &rsaquo; <a href="{% url 'admin:app_list' app_label=opts.app_label %}">{{ opts.app_label|capfirst }}</a>
    &rsaquo; <a href="{% url opts|admin_urlname:'changelist' %}">{{ opts.verbose_name_plural|capfirst }}</a>
    &rsaquo; {{ title }}
</div>
{% endblock %}

{% block content %}
<div id="easypay-dashboard" class="max-w-7xl mx-auto px-4 py-6">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
        <h1 class="text-2xl font-bold text-gray-900">{{ title }}</h1>
        <div class="date-range-selector flex flex-wrap gap-2">
            <button type="button" data-range="month" class="px-4 py-2 text-sm font-medium rounded-md border {% if date_range == 'month' %}active{% else %}bg-white text-gray-700 border-gray-300 hover:bg-gray-50{% endif %}">
                ì´ë²ˆë‹¬
            </button>
            <button type="button" data-range="today" class="px-4 py-2 text-sm font-medium rounded-md border {% if date_range == 'today' %}active{% else %}bg-white text-gray-700 border-gray-300 hover:bg-gray-50{% endif %}">
                ì˜¤ëŠ˜
            </button>
            <button type="button" data-range="7d" class="px-4 py-2 text-sm font-medium rounded-md border {% if date_range == '7d' %}active{% else %}bg-white text-gray-700 border-gray-300 hover:bg-gray-50{% endif %}">
                7ì¼
            </button>
            <button type="button" data-range="30d" class="px-4 py-2 text-sm font-medium rounded-md border {% if date_range == '30d' %}active{% else %}bg-white text-gray-700 border-gray-300 hover:bg-gray-50{% endif %}">
                30ì¼
            </button>
            <button type="button" data-range="90d" class="px-4 py-2 text-sm font-medium rounded-md border {% if date_range == '90d' %}active{% else %}bg-white text-gray-700 border-gray-300 hover:bg-gray-50{% endif %}">
                90ì¼
            </button>
            <button type="button" data-range="custom" id="customRangeBtn" class="px-4 py-2 text-sm font-medium rounded-md border {% if date_range == 'custom' %}active{% else %}bg-white text-gray-700 border-gray-300 hover:bg-gray-50{% endif %}">
                ì§ì ‘ì„ íƒ
            </button>
        </div>
    </div>

    <div id="customDatePicker" class="bg-gray-50 rounded-lg p-4 mb-6" {% if date_range != 'custom' %}style="display: none;"{% endif %}>
        <div class="flex flex-wrap items-end gap-4 mb-6">
            <div class="flex flex-col">
                <label for="startDate" class="text-xs font-medium text-gray-500 mb-1">ì‹œì‘ì¼</label>
                <input type="date" id="startDate" value="{{ custom_start_date }}" max="{{ today }}" class="px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <span class="text-gray-400 pb-2">~</span>
            <div class="flex flex-col">
                <label for="endDate" class="text-xs font-medium text-gray-500 mb-1">ì¢…ë£Œì¼</label>
                <input type="date" id="endDate" value="{{ custom_end_date }}" max="{{ today }}" class="px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <button type="button" id="applyDateRange" class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-md hover:bg-indigo-700">ì ìš©</button>
            <button type="button" id="exportCsv" class="px-4 py-2 bg-emerald-600 text-white text-sm font-medium rounded-md hover:bg-emerald-700">CSV ë‹¤ìš´ë¡œë“œ</button>
        </div>
        
        <div class="calendar-container max-w-md">
            <div class="flex items-center justify-center gap-4 mb-4">
                <button type="button" id="prevMonth" class="p-2 text-gray-400 hover:text-gray-600">
                    &lt;
                </button>
                <span id="calendarMonth" class="text-lg font-semibold text-gray-900 min-w-[100px] text-center"></span>
                <button type="button" id="nextMonth" class="p-2 text-gray-400 hover:text-gray-600">
                    &gt;
                </button>
            </div>
            <div class="ring-1 ring-gray-200 rounded-lg overflow-hidden bg-white" id="calendarGrid">
                <div class="grid grid-cols-7 text-center text-xs font-semibold text-gray-700 bg-gray-50 border-b border-gray-200">
                    <span class="py-2">ì›”</span><span class="py-2">í™”</span><span class="py-2">ìˆ˜</span><span class="py-2">ëª©</span><span class="py-2">ê¸ˆ</span><span class="py-2 text-blue-600">í† </span><span class="py-2 text-rose-600">ì¼</span>
                </div>
                <div class="grid grid-cols-7 text-sm" id="calendarDays"></div>
            </div>
        </div>
    </div>

    <dl class="grid grid-cols-1 gap-px bg-gray-900/5 sm:grid-cols-2 lg:grid-cols-4 rounded-lg overflow-hidden mb-6">
        <div class="flex flex-wrap items-baseline justify-between gap-x-4 gap-y-2 bg-white px-4 py-8 sm:px-6">
            <dt class="text-sm font-medium text-gray-500">ğŸ’° ì´ ë§¤ì¶œ</dt>
            {% if stats.summary.total_revenue.change is not None %}
            <dd class="text-xs font-medium {% if stats.summary.total_revenue.trend == 'up' %}text-emerald-600{% elif stats.summary.total_revenue.trend == 'down' %}text-rose-600{% else %}text-gray-500{% endif %}">
                {% if stats.summary.total_revenue.trend == 'up' %}â†‘{% elif stats.summary.total_revenue.trend == 'down' %}â†“{% endif %}
                {{ stats.summary.total_revenue.change }}%
            </dd>
            {% endif %}
            <dd class="w-full flex-none text-3xl font-semibold tracking-tight text-gray-900" id="totalRevenue">{{ stats.summary.total_revenue.formatted }}</dd>
        </div>

        <div class="flex flex-wrap items-baseline justify-between gap-x-4 gap-y-2 bg-white px-4 py-8 sm:px-6">
            <dt class="text-sm font-medium text-gray-500">ğŸ“¦ ê²°ì œ ê±´ìˆ˜</dt>
            {% if stats.summary.transaction_count.change is not None %}
            <dd class="text-xs font-medium {% if stats.summary.transaction_count.trend == 'up' %}text-emerald-600{% elif stats.summary.transaction_count.trend == 'down' %}text-rose-600{% else %}text-gray-500{% endif %}">
                {% if stats.summary.transaction_count.trend == 'up' %}â†‘{% elif stats.summary.transaction_count.trend == 'down' %}â†“{% endif %}
                {{ stats.summary.transaction_count.change }}%
            </dd>
            {% endif %}
            <dd class="w-full flex-none text-3xl font-semibold tracking-tight text-gray-900" id="transactionCount">{{ stats.summary.transaction_count.formatted }}</dd>
        </div>

        <div class="flex flex-wrap items-baseline justify-between gap-x-4 gap-y-2 bg-white px-4 py-8 sm:px-6">
            <dt class="text-sm font-medium text-gray-500">ğŸ“Š í‰ê·  ê²°ì œê¸ˆì•¡</dt>
            {% if stats.summary.average_value.change is not None %}
            <dd class="text-xs font-medium {% if stats.summary.average_value.trend == 'up' %}text-emerald-600{% elif stats.summary.average_value.trend == 'down' %}text-rose-600{% else %}text-gray-500{% endif %}">
                {% if stats.summary.average_value.trend == 'up' %}â†‘{% elif stats.summary.average_value.trend == 'down' %}â†“{% endif %}
                {{ stats.summary.average_value.change }}%
            </dd>
            {% endif %}
            <dd class="w-full flex-none text-3xl font-semibold tracking-tight text-gray-900" id="averageValue">{{ stats.summary.average_value.formatted }}</dd>
        </div>

        <div class="flex flex-wrap items-baseline justify-between gap-x-4 gap-y-2 bg-white px-4 py-8 sm:px-6">
            <dt class="text-sm font-medium text-gray-500">ğŸ”„ í™˜ë¶ˆ/ì·¨ì†Œ</dt>
            {% if stats.summary.refund_count.change is not None %}
            <dd class="text-xs font-medium {% if stats.summary.refund_count.trend == 'up' %}text-emerald-600{% elif stats.summary.refund_count.trend == 'down' %}text-rose-600{% else %}text-gray-500{% endif %}">
                {% if stats.summary.refund_count.trend == 'up' %}â†‘{% elif stats.summary.refund_count.trend == 'down' %}â†“{% endif %}
                {{ stats.summary.refund_count.change }}%
            </dd>
            {% endif %}
            <dd class="w-full flex-none text-3xl font-semibold tracking-tight text-gray-900" id="refundCount">{{ stats.summary.refund_count.formatted }}</dd>
        </div>
    </dl>

    <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
        <h3 class="text-base font-semibold text-gray-900 mb-4">ì¼ë³„ ë§¤ì¶œ ì¶”ì´</h3>
        <div class="chart-container">
            <canvas id="revenueTrendChart"></canvas>
        </div>
        <details class="mt-4 pt-4 border-t border-gray-100">
            <summary class="text-sm text-gray-500 cursor-pointer hover:text-gray-700">ë°ì´í„° í…Œì´ë¸” ë³´ê¸°</summary>
            <div class="mt-3 overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead>
                        <tr class="border-b border-gray-200">
                            <th class="text-left py-2 px-3 font-medium text-gray-900">ë‚ ì§œ</th>
                            <th class="text-right py-2 px-3 font-medium text-gray-900">ë§¤ì¶œ</th>
                            <th class="text-right py-2 px-3 font-medium text-gray-900">ê±´ìˆ˜</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        {% for day in stats.charts.daily_trend %}
                        <tr>
                            <td class="py-2 px-3 text-gray-600">{{ day.date }}</td>
                            <td class="py-2 px-3 text-right text-gray-900">â‚©{{ day.revenue|floatformat:0 }}</td>
                            <td class="py-2 px-3 text-right text-gray-900">{{ day.count }}ê±´</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="3" class="py-4 text-center text-gray-400">ë°ì´í„° ì—†ìŒ</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </details>
    </div>

    <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
        <h3 class="text-base font-semibold text-gray-900 mb-4">ê¸°ê°„ ë¹„êµ (í˜„ì¬ vs ì´ì „)</h3>
        <p class="comparison-period-info text-sm text-gray-500 mb-4">
            í˜„ì¬: {{ stats.meta.start_date }} ~ {{ stats.meta.end_date }} |
            ì´ì „: {{ stats.meta.prev_start_date }} ~ {{ stats.meta.prev_end_date }}
        </p>
        <div class="chart-container">
            <canvas id="comparisonChart"></canvas>
        </div>
        <details class="mt-4 pt-4 border-t border-gray-100">
            <summary class="text-sm text-gray-500 cursor-pointer hover:text-gray-700">ë°ì´í„° í…Œì´ë¸” ë³´ê¸°</summary>
            <div class="mt-3 overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead>
                        <tr class="border-b border-gray-200">
                            <th class="text-left py-2 px-3 font-medium text-gray-900">í•­ëª©</th>
                            <th class="text-right py-2 px-3 font-medium text-gray-900">í˜„ì¬ ê¸°ê°„</th>
                            <th class="text-right py-2 px-3 font-medium text-gray-900">ì´ì „ ê¸°ê°„</th>
                            <th class="text-right py-2 px-3 font-medium text-gray-900">ë³€í™”</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        {% for item in stats.comparison %}
                        <tr>
                            <td class="py-2 px-3 text-gray-600">{{ item.label }}</td>
                            <td class="py-2 px-3 text-right text-gray-900">{% if item.label == 'ë§¤ì¶œ' or item.label == 'í‰ê· ê¸ˆì•¡' %}â‚©{{ item.current|floatformat:0 }}{% else %}{{ item.current }}ê±´{% endif %}</td>
                            <td class="py-2 px-3 text-right text-gray-900">{% if item.label == 'ë§¤ì¶œ' or item.label == 'í‰ê· ê¸ˆì•¡' %}â‚©{{ item.previous|floatformat:0 }}{% else %}{{ item.previous }}ê±´{% endif %}</td>
                            <td class="py-2 px-3 text-right font-medium {% if item.current > item.previous %}text-emerald-600{% elif item.current < item.previous %}text-rose-600{% endif %}">
                                {% if item.previous > 0 %}
                                    {% widthratio item.current item.previous 100 as change_pct %}
                                    {% if item.current > item.previous %}â†‘{% elif item.current < item.previous %}â†“{% endif %}
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="4" class="py-4 text-center text-gray-400">ë°ì´í„° ì—†ìŒ</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </details>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="bg-white rounded-lg border border-gray-200 p-6">
            <h3 class="text-base font-semibold text-gray-900 mb-4">ìƒíƒœë³„ ë¶„í¬</h3>
            <div class="chart-container-small">
                <canvas id="statusChart"></canvas>
            </div>
            <details class="mt-4 pt-4 border-t border-gray-100">
                <summary class="text-sm text-gray-500 cursor-pointer hover:text-gray-700">ë°ì´í„° í…Œì´ë¸” ë³´ê¸°</summary>
                <div class="mt-3 overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left py-2 px-3 font-medium text-gray-900">ìƒíƒœ</th>
                                <th class="text-right py-2 px-3 font-medium text-gray-900">ê±´ìˆ˜</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            {% for item in stats.charts.by_status %}
                            <tr>
                                <td class="py-2 px-3 text-gray-600"><span class="inline-block w-2.5 h-2.5 rounded-full mr-2" style="background-color: {{ item.color }};"></span> {{ item.label }}</td>
                                <td class="py-2 px-3 text-right text-gray-900">{{ item.count }}ê±´</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="2" class="py-4 text-center text-gray-400">ë°ì´í„° ì—†ìŒ</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </details>
        </div>
        <div class="bg-white rounded-lg border border-gray-200 p-6">
            <h3 class="text-base font-semibold text-gray-900 mb-4">ê²°ì œìˆ˜ë‹¨ë³„ ë§¤ì¶œ</h3>
            <div class="chart-container-small">
                <canvas id="methodChart"></canvas>
            </div>
            <details class="mt-4 pt-4 border-t border-gray-100">
                <summary class="text-sm text-gray-500 cursor-pointer hover:text-gray-700">ë°ì´í„° í…Œì´ë¸” ë³´ê¸°</summary>
                <div class="mt-3 overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left py-2 px-3 font-medium text-gray-900">ê²°ì œìˆ˜ë‹¨</th>
                                <th class="text-right py-2 px-3 font-medium text-gray-900">ê±´ìˆ˜</th>
                                <th class="text-right py-2 px-3 font-medium text-gray-900">ë§¤ì¶œ</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            {% for item in stats.charts.by_method %}
                            <tr>
                                <td class="py-2 px-3 text-gray-600">{{ item.label }}</td>
                                <td class="py-2 px-3 text-right text-gray-900">{{ item.count }}ê±´</td>
                                <td class="py-2 px-3 text-right text-gray-900">â‚©{{ item.revenue|floatformat:0 }}</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="3" class="py-4 text-center text-gray-400">ë°ì´í„° ì—†ìŒ</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </details>
        </div>
    </div>

    <div class="flex gap-3 pt-6 border-t border-gray-200">
        <a href="{% url opts|admin_urlname:'changelist' %}" class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-md hover:bg-indigo-700">
            â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
        </a>
    </div>
</div>

<script src="{% static 'easypay/dashboard/dashboard.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    EasyPayDashboard.init({
        apiUrl: '{{ api_url }}',
        initialRange: '{{ date_range }}',
        chartData: {{ chart_data|safe }},
        customStartDate: '{{ custom_start_date }}',
        customEndDate: '{{ custom_end_date }}',
        today: '{{ today }}',
        exportUrl: '?export=csv'
    });
});
</script>
{% endblock %}
