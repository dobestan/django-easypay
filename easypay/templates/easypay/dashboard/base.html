{% extends "admin/base_site.html" %}
{% load static i18n admin_urls %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block extrahead %}
{{ block.super }}
<link rel="stylesheet" crossorigin
  href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.min.css" />
<link rel="stylesheet" href="{% static 'easypay/dashboard/dashboard.css' %}" />
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
    &rsaquo; <a href="{% url 'admin:app_list' app_label=opts.app_label %}">{{ opts.app_label|capfirst }}</a>
    &rsaquo; <a href="{% url opts|admin_urlname:'changelist' %}">{{ opts.verbose_name_plural|capfirst }}</a>
    &rsaquo; {{ title }}
</div>
{% endblock %}

{% block content %}
<div id="easypay-dashboard" class="max-w-7xl mx-auto px-4 py-6">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
        <h1 class="text-2xl font-bold text-gray-900">{{ title }}</h1>
        <div class="flex gap-2">
            <button type="button" id="viewCalendar" class="px-4 py-2 text-sm font-medium rounded-md border bg-indigo-600 text-white border-indigo-600">
                ìº˜ë¦°ë”
            </button>
            <button type="button" id="viewCharts" class="px-4 py-2 text-sm font-medium rounded-md border bg-white text-gray-700 border-gray-300 hover:bg-gray-50">
                ì°¨íŠ¸
            </button>
        </div>
    </div>

    <dl class="grid grid-cols-1 gap-px bg-gray-900/5 sm:grid-cols-2 lg:grid-cols-4 rounded-lg overflow-hidden mb-6">
        <div class="flex flex-wrap items-baseline justify-between gap-x-4 gap-y-2 bg-white px-4 py-8 sm:px-6">
            <dt class="text-sm font-medium text-gray-500">ğŸ’° ì´ ë§¤ì¶œ</dt>
            {% if stats.summary.total_revenue.change is not None %}
            <dd class="text-xs font-medium {% if stats.summary.total_revenue.trend == 'up' %}text-emerald-600{% elif stats.summary.total_revenue.trend == 'down' %}text-rose-600{% else %}text-gray-500{% endif %}">
                {% if stats.summary.total_revenue.trend == 'up' %}â†‘{% elif stats.summary.total_revenue.trend == 'down' %}â†“{% endif %}
                {{ stats.summary.total_revenue.change }}%
            </dd>
            {% endif %}
            <dd class="w-full flex-none text-3xl font-semibold tracking-tight text-gray-900" id="totalRevenue">{{ stats.summary.total_revenue.formatted }}</dd>
        </div>

        <div class="flex flex-wrap items-baseline justify-between gap-x-4 gap-y-2 bg-white px-4 py-8 sm:px-6">
            <dt class="text-sm font-medium text-gray-500">ğŸ“¦ ê²°ì œ ê±´ìˆ˜</dt>
            {% if stats.summary.transaction_count.change is not None %}
            <dd class="text-xs font-medium {% if stats.summary.transaction_count.trend == 'up' %}text-emerald-600{% elif stats.summary.transaction_count.trend == 'down' %}text-rose-600{% else %}text-gray-500{% endif %}">
                {% if stats.summary.transaction_count.trend == 'up' %}â†‘{% elif stats.summary.transaction_count.trend == 'down' %}â†“{% endif %}
                {{ stats.summary.transaction_count.change }}%
            </dd>
            {% endif %}
            <dd class="w-full flex-none text-3xl font-semibold tracking-tight text-gray-900" id="transactionCount">{{ stats.summary.transaction_count.formatted }}</dd>
        </div>

        <div class="flex flex-wrap items-baseline justify-between gap-x-4 gap-y-2 bg-white px-4 py-8 sm:px-6">
            <dt class="text-sm font-medium text-gray-500">ğŸ“Š í‰ê·  ê²°ì œê¸ˆì•¡</dt>
            {% if stats.summary.average_value.change is not None %}
            <dd class="text-xs font-medium {% if stats.summary.average_value.trend == 'up' %}text-emerald-600{% elif stats.summary.average_value.trend == 'down' %}text-rose-600{% else %}text-gray-500{% endif %}">
                {% if stats.summary.average_value.trend == 'up' %}â†‘{% elif stats.summary.average_value.trend == 'down' %}â†“{% endif %}
                {{ stats.summary.average_value.change }}%
            </dd>
            {% endif %}
            <dd class="w-full flex-none text-3xl font-semibold tracking-tight text-gray-900" id="averageValue">{{ stats.summary.average_value.formatted }}</dd>
        </div>

        <div class="flex flex-wrap items-baseline justify-between gap-x-4 gap-y-2 bg-white px-4 py-8 sm:px-6">
            <dt class="text-sm font-medium text-gray-500">ğŸ”„ í™˜ë¶ˆ/ì·¨ì†Œ</dt>
            {% if stats.summary.refund_count.change is not None %}
            <dd class="text-xs font-medium {% if stats.summary.refund_count.trend == 'up' %}text-emerald-600{% elif stats.summary.refund_count.trend == 'down' %}text-rose-600{% else %}text-gray-500{% endif %}">
                {% if stats.summary.refund_count.trend == 'up' %}â†‘{% elif stats.summary.refund_count.trend == 'down' %}â†“{% endif %}
                {{ stats.summary.refund_count.change }}%
            </dd>
            {% endif %}
            <dd class="w-full flex-none text-3xl font-semibold tracking-tight text-gray-900" id="refundCount">{{ stats.summary.refund_count.formatted }}</dd>
        </div>
    </dl>

    <div id="calendarView" class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-base font-semibold text-gray-900">ì›”ë³„ ë§¤ì¶œ ìº˜ë¦°ë”</h3>
            <div class="flex items-center gap-3">
                <button type="button" id="calendarPrev" class="p-2 rounded-md hover:bg-gray-100">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
                <span id="calendarTitle" class="text-lg font-semibold text-gray-900 min-w-[140px] text-center"></span>
                <button type="button" id="calendarNext" class="p-2 rounded-md hover:bg-gray-100">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
                <button type="button" id="calendarToday" class="ml-2 px-3 py-1.5 text-sm font-medium text-indigo-600 border border-indigo-300 rounded-md hover:bg-indigo-50">
                    ì˜¤ëŠ˜
                </button>
            </div>
        </div>
        
        <div class="ring-1 ring-gray-200 rounded-lg overflow-hidden">
            <div class="grid grid-cols-7 text-center text-xs font-semibold text-gray-700 bg-gray-50 border-b border-gray-200">
                <span class="py-3">ì›”</span>
                <span class="py-3">í™”</span>
                <span class="py-3">ìˆ˜</span>
                <span class="py-3">ëª©</span>
                <span class="py-3">ê¸ˆ</span>
                <span class="py-3 text-blue-600">í† </span>
                <span class="py-3 text-rose-600">ì¼</span>
            </div>
            <div id="calendarGrid" class="grid grid-cols-7 divide-x divide-y divide-gray-200 bg-gray-200"></div>
        </div>
        
        <div class="mt-4 flex items-center gap-4 text-xs text-gray-500">
            <span class="flex items-center gap-1">
                <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
                ë§¤ì¶œ ìˆìŒ
            </span>
            <span>í´ë¦­í•˜ì—¬ í•´ë‹¹ ì¼ì ì£¼ë¬¸ ëª©ë¡ ë³´ê¸°</span>
        </div>
    </div>

    <div id="chartsView" class="hidden">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4">
            <div class="date-range-selector flex flex-wrap gap-2">
                <button type="button" data-range="month" class="px-4 py-2 text-sm font-medium rounded-md border {% if date_range == 'month' %}active{% else %}bg-white text-gray-700 border-gray-300 hover:bg-gray-50{% endif %}">
                    ì´ë²ˆë‹¬
                </button>
                <button type="button" data-range="today" class="px-4 py-2 text-sm font-medium rounded-md border {% if date_range == 'today' %}active{% else %}bg-white text-gray-700 border-gray-300 hover:bg-gray-50{% endif %}">
                    ì˜¤ëŠ˜
                </button>
                <button type="button" data-range="7d" class="px-4 py-2 text-sm font-medium rounded-md border {% if date_range == '7d' %}active{% else %}bg-white text-gray-700 border-gray-300 hover:bg-gray-50{% endif %}">
                    7ì¼
                </button>
                <button type="button" data-range="30d" class="px-4 py-2 text-sm font-medium rounded-md border {% if date_range == '30d' %}active{% else %}bg-white text-gray-700 border-gray-300 hover:bg-gray-50{% endif %}">
                    30ì¼
                </button>
                <button type="button" data-range="90d" class="px-4 py-2 text-sm font-medium rounded-md border {% if date_range == '90d' %}active{% else %}bg-white text-gray-700 border-gray-300 hover:bg-gray-50{% endif %}">
                    90ì¼
                </button>
                <button type="button" data-range="custom" id="customRangeBtn" class="px-4 py-2 text-sm font-medium rounded-md border {% if date_range == 'custom' %}active{% else %}bg-white text-gray-700 border-gray-300 hover:bg-gray-50{% endif %}">
                    ì§ì ‘ì„ íƒ
                </button>
            </div>
        </div>

        <div id="customDatePicker" class="bg-gray-50 rounded-lg p-4 mb-6" {% if date_range != 'custom' %}style="display: none;"{% endif %}>
            <div class="flex flex-wrap items-end gap-4">
                <div class="flex flex-col">
                    <label for="startDate" class="text-xs font-medium text-gray-500 mb-1">ì‹œì‘ì¼</label>
                    <input type="date" id="startDate" value="{{ custom_start_date }}" max="{{ today }}" class="px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <span class="text-gray-400 pb-2">~</span>
                <div class="flex flex-col">
                    <label for="endDate" class="text-xs font-medium text-gray-500 mb-1">ì¢…ë£Œì¼</label>
                    <input type="date" id="endDate" value="{{ custom_end_date }}" max="{{ today }}" class="px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <button type="button" id="applyDateRange" class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-md hover:bg-indigo-700">ì ìš©</button>
                <button type="button" id="exportCsv" class="px-4 py-2 bg-emerald-600 text-white text-sm font-medium rounded-md hover:bg-emerald-700">CSV ë‹¤ìš´ë¡œë“œ</button>
            </div>
        </div>

        <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
            <h3 class="text-base font-semibold text-gray-900 mb-4">ì¼ë³„ ë§¤ì¶œ ì¶”ì´</h3>
            <div class="chart-container">
                <canvas id="revenueTrendChart"></canvas>
            </div>
            <details class="mt-4 pt-4 border-t border-gray-100">
                <summary class="text-sm text-gray-500 cursor-pointer hover:text-gray-700">ë°ì´í„° í…Œì´ë¸” ë³´ê¸°</summary>
                <div class="mt-3 overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left py-2 px-3 font-medium text-gray-900">ë‚ ì§œ</th>
                                <th class="text-right py-2 px-3 font-medium text-gray-900">ë§¤ì¶œ</th>
                                <th class="text-right py-2 px-3 font-medium text-gray-900">ê±´ìˆ˜</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            {% for day in stats.charts.daily_trend %}
                            <tr>
                                <td class="py-2 px-3 text-gray-600">{{ day.date }}</td>
                                <td class="py-2 px-3 text-right text-gray-900">â‚©{{ day.revenue|floatformat:0 }}</td>
                                <td class="py-2 px-3 text-right text-gray-900">{{ day.count }}ê±´</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="3" class="py-4 text-center text-gray-400">ë°ì´í„° ì—†ìŒ</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </details>
        </div>

        <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
            <h3 class="text-base font-semibold text-gray-900 mb-4">ê¸°ê°„ ë¹„êµ (í˜„ì¬ vs ì´ì „)</h3>
            <p class="comparison-period-info text-sm text-gray-500 mb-4">
                í˜„ì¬: {{ stats.meta.start_date }} ~ {{ stats.meta.end_date }} |
                ì´ì „: {{ stats.meta.prev_start_date }} ~ {{ stats.meta.prev_end_date }}
            </p>
            <div class="chart-container">
                <canvas id="comparisonChart"></canvas>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="bg-white rounded-lg border border-gray-200 p-6">
                <h3 class="text-base font-semibold text-gray-900 mb-4">ìƒíƒœë³„ ë¶„í¬</h3>
                <div class="chart-container-small">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
            <div class="bg-white rounded-lg border border-gray-200 p-6">
                <h3 class="text-base font-semibold text-gray-900 mb-4">ê²°ì œìˆ˜ë‹¨ë³„ ë§¤ì¶œ</h3>
                <div class="chart-container-small">
                    <canvas id="methodChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="flex gap-3 pt-6 border-t border-gray-200">
        <a href="{% url opts|admin_urlname:'changelist' %}" class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-md hover:bg-indigo-700">
            â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
        </a>
    </div>
</div>

<script src="{% static 'easypay/dashboard/dashboard.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const calendarView = document.getElementById('calendarView');
    const chartsView = document.getElementById('chartsView');
    const viewCalendarBtn = document.getElementById('viewCalendar');
    const viewChartsBtn = document.getElementById('viewCharts');
    const calendarGrid = document.getElementById('calendarGrid');
    const calendarTitle = document.getElementById('calendarTitle');
    const orderListUrl = "{% url opts|admin_urlname:'changelist' %}";

    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth() + 1;

    function showCalendar() {
        calendarView.classList.remove('hidden');
        chartsView.classList.add('hidden');
        viewCalendarBtn.classList.remove('bg-white', 'text-gray-700', 'border-gray-300');
        viewCalendarBtn.classList.add('bg-indigo-600', 'text-white', 'border-indigo-600');
        viewChartsBtn.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-600');
        viewChartsBtn.classList.add('bg-white', 'text-gray-700', 'border-gray-300');
    }

    function showCharts() {
        calendarView.classList.add('hidden');
        chartsView.classList.remove('hidden');
        viewChartsBtn.classList.remove('bg-white', 'text-gray-700', 'border-gray-300');
        viewChartsBtn.classList.add('bg-indigo-600', 'text-white', 'border-indigo-600');
        viewCalendarBtn.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-600');
        viewCalendarBtn.classList.add('bg-white', 'text-gray-700', 'border-gray-300');
        
        if (!window.chartsInitialized) {
            EasyPayDashboard.init({
                apiUrl: '{{ api_url }}',
                initialRange: '{{ date_range }}',
                chartData: {{ chart_data|safe }},
                customStartDate: '{{ custom_start_date }}',
                customEndDate: '{{ custom_end_date }}',
                today: '{{ today }}',
                exportUrl: '?export=csv'
            });
            window.chartsInitialized = true;
        }
    }

    viewCalendarBtn.addEventListener('click', showCalendar);
    viewChartsBtn.addEventListener('click', showCharts);

    function formatCurrency(value) {
        return 'â‚©' + value.toLocaleString('ko-KR');
    }

    function getFirstDayOfMonth(year, month) {
        const day = new Date(year, month - 1, 1).getDay();
        return day === 0 ? 6 : day - 1;
    }

    function renderCalendar(year, month, days) {
        const monthNames = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];
        calendarTitle.textContent = `${year}ë…„ ${monthNames[month - 1]}`;

        calendarGrid.innerHTML = '';

        const firstDay = getFirstDayOfMonth(year, month);
        const today = new Date();
        const isCurrentMonth = year === today.getFullYear() && month === today.getMonth() + 1;

        for (let i = 0; i < firstDay; i++) {
            const emptyCell = document.createElement('div');
            emptyCell.className = 'bg-gray-50 min-h-[100px] p-2';
            calendarGrid.appendChild(emptyCell);
        }

        days.forEach((day) => {
            const cell = document.createElement('div');
            const isToday = isCurrentMonth && day.day === today.getDate();
            const hasRevenue = day.revenue > 0;
            const dayOfWeek = (firstDay + day.day - 1) % 7;
            const isSaturday = dayOfWeek === 5;
            const isSunday = dayOfWeek === 6;

            cell.className = `bg-white min-h-[100px] p-2 cursor-pointer hover:bg-gray-50 transition-colors ${isToday ? 'ring-2 ring-inset ring-indigo-500' : ''}`;
            
            let dayClass = 'text-sm font-medium';
            if (isSaturday) dayClass += ' text-blue-600';
            else if (isSunday) dayClass += ' text-rose-600';
            else dayClass += ' text-gray-900';

            cell.innerHTML = `
                <div class="flex items-center gap-1 mb-1">
                    <span class="${dayClass}">${day.day}</span>
                    ${hasRevenue ? '<span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>' : ''}
                </div>
                ${hasRevenue ? `
                    <div class="text-xs text-gray-600 space-y-0.5">
                        <div class="font-semibold text-emerald-600">${formatCurrency(day.revenue)}</div>
                        <div>${day.count}ê±´</div>
                    </div>
                ` : ''}
            `;

            cell.addEventListener('click', () => {
                const url = `${orderListUrl}?status=completed&paid_at__date__gte=${day.date}&paid_at__date__lte=${day.date}`;
                window.location.href = url;
            });

            calendarGrid.appendChild(cell);
        });

        const totalCells = firstDay + days.length;
        const remainingCells = (7 - (totalCells % 7)) % 7;
        for (let i = 0; i < remainingCells; i++) {
            const emptyCell = document.createElement('div');
            emptyCell.className = 'bg-gray-50 min-h-[100px] p-2';
            calendarGrid.appendChild(emptyCell);
        }
    }

    function loadCalendar(year, month) {
        currentYear = year;
        currentMonth = month;
        
        fetch(`calendar/?year=${year}&month=${month}`)
            .then(response => response.json())
            .then(data => {
                renderCalendar(data.year, data.month, data.days);
            })
            .catch(error => {
                console.error('Calendar load failed:', error);
            });
    }

    document.getElementById('calendarPrev').addEventListener('click', () => {
        let newMonth = currentMonth - 1;
        let newYear = currentYear;
        if (newMonth < 1) {
            newMonth = 12;
            newYear--;
        }
        loadCalendar(newYear, newMonth);
    });

    document.getElementById('calendarNext').addEventListener('click', () => {
        let newMonth = currentMonth + 1;
        let newYear = currentYear;
        if (newMonth > 12) {
            newMonth = 1;
            newYear++;
        }
        loadCalendar(newYear, newMonth);
    });

    document.getElementById('calendarToday').addEventListener('click', () => {
        const today = new Date();
        loadCalendar(today.getFullYear(), today.getMonth() + 1);
    });

    loadCalendar(currentYear, currentMonth);
});
</script>
{% endblock %}
