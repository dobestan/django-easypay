{% extends "admin/base_site.html" %}
{% load static i18n admin_urls %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block extrahead %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<link rel="stylesheet" href="{% static 'easypay/dashboard/dashboard.css' %}">
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
    &rsaquo; <a href="{% url 'admin:app_list' app_label=opts.app_label %}">{{ opts.app_label|capfirst }}</a>
    &rsaquo; <a href="{% url opts|admin_urlname:'changelist' %}">{{ opts.verbose_name_plural|capfirst }}</a>
    &rsaquo; {{ title }}
</div>
{% endblock %}

{% block content %}
<div id="easypay-dashboard" class="easypay-dashboard">
    <!-- Header with Date Range Selector -->
    <div class="dashboard-header">
        <h1>{{ title }}</h1>
        <div class="date-range-selector">
            <button type="button" data-range="month" {% if date_range == 'month' %}class="active"{% endif %}>
                ì´ë²ˆë‹¬
            </button>
            <button type="button" data-range="today" {% if date_range == 'today' %}class="active"{% endif %}>
                ì˜¤ëŠ˜
            </button>
            <button type="button" data-range="7d" {% if date_range == '7d' %}class="active"{% endif %}>
                7ì¼
            </button>
            <button type="button" data-range="30d" {% if date_range == '30d' %}class="active"{% endif %}>
                30ì¼
            </button>
            <button type="button" data-range="90d" {% if date_range == '90d' %}class="active"{% endif %}>
                90ì¼
            </button>
            <button type="button" data-range="custom" id="customRangeBtn" {% if date_range == 'custom' %}class="active"{% endif %}>
                ì§ì ‘ì„ íƒ
            </button>
        </div>
    </div>

    <!-- Custom Date Range Picker -->
    <div id="customDatePicker" class="custom-date-picker" {% if date_range != 'custom' %}style="display: none;"{% endif %}>
        <div class="date-picker-row">
            <div class="date-input-group">
                <label for="startDate">ì‹œì‘ì¼</label>
                <input type="date" id="startDate" value="{{ custom_start_date }}" max="{{ today }}">
            </div>
            <span class="date-separator">~</span>
            <div class="date-input-group">
                <label for="endDate">ì¢…ë£Œì¼</label>
                <input type="date" id="endDate" value="{{ custom_end_date }}" max="{{ today }}">
            </div>
            <button type="button" id="applyDateRange" class="apply-btn">ì ìš©</button>
            <button type="button" id="exportCsv" class="export-btn">CSV ë‹¤ìš´ë¡œë“œ</button>
        </div>
        <div class="calendar-container">
            <div class="calendar-nav">
                <button type="button" id="prevMonth">&lt;</button>
                <span id="calendarMonth"></span>
                <button type="button" id="nextMonth">&gt;</button>
            </div>
            <div class="calendar-grid" id="calendarGrid">
                <div class="calendar-header">
                    <span>ì›”</span><span>í™”</span><span>ìˆ˜</span><span>ëª©</span><span>ê¸ˆ</span><span class="weekend">í† </span><span class="weekend sunday">ì¼</span>
                </div>
                <div class="calendar-days" id="calendarDays"></div>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="summary-cards">
        <div class="summary-card">
            <div class="card-icon card-icon-revenue">ğŸ’°</div>
            <div class="card-content">
                <span class="card-label">ì´ ë§¤ì¶œ</span>
                <span class="card-value" id="totalRevenue">{{ stats.summary.total_revenue.formatted }}</span>
                {% if stats.summary.total_revenue.change is not None %}
                <span class="card-change {{ stats.summary.total_revenue.trend }}">
                    {% if stats.summary.total_revenue.trend == 'up' %}â†‘{% elif stats.summary.total_revenue.trend == 'down' %}â†“{% endif %}
                    {{ stats.summary.total_revenue.change }}%
                </span>
                {% endif %}
            </div>
        </div>

        <div class="summary-card">
            <div class="card-icon card-icon-count">ğŸ“¦</div>
            <div class="card-content">
                <span class="card-label">ê²°ì œ ê±´ìˆ˜</span>
                <span class="card-value" id="transactionCount">{{ stats.summary.transaction_count.formatted }}</span>
                {% if stats.summary.transaction_count.change is not None %}
                <span class="card-change {{ stats.summary.transaction_count.trend }}">
                    {% if stats.summary.transaction_count.trend == 'up' %}â†‘{% elif stats.summary.transaction_count.trend == 'down' %}â†“{% endif %}
                    {{ stats.summary.transaction_count.change }}%
                </span>
                {% endif %}
            </div>
        </div>

        <div class="summary-card">
            <div class="card-icon card-icon-average">ğŸ“Š</div>
            <div class="card-content">
                <span class="card-label">í‰ê·  ê²°ì œê¸ˆì•¡</span>
                <span class="card-value" id="averageValue">{{ stats.summary.average_value.formatted }}</span>
                {% if stats.summary.average_value.change is not None %}
                <span class="card-change {{ stats.summary.average_value.trend }}">
                    {% if stats.summary.average_value.trend == 'up' %}â†‘{% elif stats.summary.average_value.trend == 'down' %}â†“{% endif %}
                    {{ stats.summary.average_value.change }}%
                </span>
                {% endif %}
            </div>
        </div>

        <div class="summary-card">
            <div class="card-icon card-icon-refund">ğŸ”„</div>
            <div class="card-content">
                <span class="card-label">í™˜ë¶ˆ/ì·¨ì†Œ</span>
                <span class="card-value" id="refundCount">{{ stats.summary.refund_count.formatted }}</span>
                {% if stats.summary.refund_count.change is not None %}
                <span class="card-change {{ stats.summary.refund_count.trend }}">
                    {% if stats.summary.refund_count.trend == 'up' %}â†‘{% elif stats.summary.refund_count.trend == 'down' %}â†“{% endif %}
                    {{ stats.summary.refund_count.change }}%
                </span>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Main Revenue Trend Chart -->
    <div class="chart-container chart-main">
        <h3>ì¼ë³„ ë§¤ì¶œ ì¶”ì´</h3>
        <div class="chart-wrapper">
            <canvas id="revenueTrendChart"></canvas>
        </div>
    </div>

    <!-- Period Comparison Chart -->
    <div class="chart-container chart-main">
        <h3>ê¸°ê°„ ë¹„êµ (í˜„ì¬ vs ì´ì „)</h3>
        <p class="comparison-period-info">
            í˜„ì¬: {{ stats.meta.start_date }} ~ {{ stats.meta.end_date }} |
            ì´ì „: {{ stats.meta.prev_start_date }} ~ {{ stats.meta.prev_end_date }}
        </p>
        <div class="chart-wrapper">
            <canvas id="comparisonChart"></canvas>
        </div>
    </div>

    <!-- Breakdown Charts Row -->
    <div class="chart-row">
        <div class="chart-container chart-half">
            <h3>ìƒíƒœë³„ ë¶„í¬</h3>
            <div class="chart-wrapper chart-wrapper-small">
                <canvas id="statusChart"></canvas>
            </div>
        </div>
        <div class="chart-container chart-half">
            <h3>ê²°ì œìˆ˜ë‹¨ë³„ ë§¤ì¶œ</h3>
            <div class="chart-wrapper chart-wrapper-small">
                <canvas id="methodChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Back to list link -->
    <div class="dashboard-footer">
        <a href="{% url opts|admin_urlname:'changelist' %}" class="button">
            â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
        </a>
    </div>
</div>

<script src="{% static 'easypay/dashboard/dashboard.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    EasyPayDashboard.init({
        apiUrl: '{{ api_url }}',
        initialRange: '{{ date_range }}',
        chartData: {{ chart_data|safe }},
        customStartDate: '{{ custom_start_date }}',
        customEndDate: '{{ custom_end_date }}',
        today: '{{ today }}',
        exportUrl: 'export/'
    });
});
</script>
{% endblock %}
